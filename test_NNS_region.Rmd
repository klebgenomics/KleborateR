---
title: "calculate prevalences for Kp NNS"
author: "Kat Holt"
date: '2023-06-07'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = getwd())

library(ggplot2)
library(tidyverse)
library(dplyr)
library(patchwork)
library(meta)
```

# calculate raw and adjusted prevalences

``` {r}
# load kleborate processing functions
source('kleborate_functions.R')

```

``` {r}

data <- read_csv("testdata/kleborate_NNS.csv")

```

``` {r}
include_study <- c("Barnards", "CHAMPS", "CHRF_bangladesh", "GHRU_Nigeria", "heinz_pakistan_2019", "malawi_nns", "spinz")
includ_agegroup <- c("neonatal", "neonate", "neonates")

data_NNS <- data %>% 
  filter(Study %in% include_study) %>% 
  filter(Age_group %in% includ_agegroup) %>%
  genome_filter(k_typable=F, o_typable=F)  # QC on genome stats, not intactness of KL/OL

sites_n10 <- data_NNS %>% 
  group_by(Study, Country, Site) %>% 
  summarise(n=n()) %>% 
  filter(n>=10)

```

# per-site prevalence, for sites with Nâ‰¥10 genomes
``` {r}
site_prevalence <- data_NNS %>% 
  filter(Site %in% sites_n10$Site) %>%
  raw_adj_prop(grouping_vars = c("K_locus", "Site"), summarise_by = "Site", adj_vars = c("Cluster", "Site"))

site_prevalence_site_sums <- site_prevalence %>%
  select(Site, raw_sum, adj_sum) %>% unique()

site_country <- data_NNS %>%
  select(Site, Country, Subregion) %>% 
  unique()

# annotate sites with country and region, fill in 0 counts, for meta-analysis
site_prevalence <- site_prevalence %>% 
  select(-c(raw_sum, adj_sum)) %>%
  complete(K_locus, Site, fill=list(raw_count=0, adj_count=0, raw_prop=0, adj_prop=0)) %>%
  left_join(site_prevalence_site_sums, by=c("Site")) %>%
  left_join(site_country, by=c("Site"))

```


# meta-analysis: pooled estimates (region as subgroup) for raw counts
``` {r}
  # setup variables to store results
  global_est <- read_csv("\n", col_names = c("K_locus", "est", "lower", "upper"))
  country_est <- read_csv("\n", col_names = c("K_locus", unique(site_prevalence$Subregion)))
  country_est_lower <- read_csv("\n", col_names = c("K_locus", unique(site_prevalence$Subregion)))
  country_est_upper <- read_csv("\n", col_names = c("K_locus", unique(site_prevalence$Subregion)))
    
  # fit metaprop model for each K and store results
  for (kl in unique(site_prevalence$K_locus)) {
    
    # model output
    site_est <- NULL
    
    suppressWarnings({
      
    # try to fit with GLMM
    u <- try(
      site_est <- site_prevalence %>%
      filter(K_locus==kl) %>% 
      metaprop(event=raw_count, n=raw_sum, studlab=Site, subgroup=Subregion,  
        method = "GLMM", sm = "PLOGIT", fixed = FALSE, random = TRUE, method.random.ci = TRUE, method.incr = "if0all", control=list(maxiter=1000,stepadj=0.5), warn=F),
    silent=T)
    
    # if didnt' work, try to fit with Inverse
    if (is.null(site_est)) {
      u <- try(
        site_est <- site_prevalence %>%
        filter(K_locus==kl) %>% 
        metaprop(event=raw_count, n=raw_sum, studlab=Site, subgroup=Subregion,  
          method = "Inverse", sm = "PLOGIT", fixed = FALSE, random = TRUE, method.random.ci = TRUE, method.incr = "if0all", control=list(maxiter=1000,stepadj=0.5), warn=F),
      silent=T)
    }
    
    })
    
    # if we have a model result, store the output
    if(!is.null(site_est)) {
       global_est <- bind_rows(global_est, 
                               c(K_locus=kl,
                                      est=1/(1+exp(-1*site_est$TE.random)),
                                      lower=1/(1+exp(-1*site_est$lower.random)),
                                      upper=1/(1+exp(-1*site_est$upper.random)) 
                               )
                        )
       country_est <- bind_rows(country_est, 
                                c(K_locus=kl, 1/(1+exp(-1*site_est$TE.random.w))))
       country_est_lower <- bind_rows(country_est_lower, 
                                      c(K_locus=kl, 1/(1+exp(-1*site_est$lower.random.w))))
       country_est_upper <- bind_rows(country_est_upper, 
                                      c(K_locus=kl, 1/(1+exp(-1*site_est$upper.random.w))))
    }
    
  }
  
# combine the outputs into a single table
country_est_lower <- country_est_lower %>% 
  rename_all(~str_replace_all(., "\\s+", "")) %>%
  rename_with(~paste0(., "_lower"), names(.)) %>% 
  rename(K_locus=K_locus_lower)

country_est_upper <- country_est_upper %>% 
  rename_all(~str_replace_all(., "\\s+", "")) %>%
  rename_with(~paste0(., "_upper"), names(.)) %>% 
  rename(K_locus=K_locus_upper)

results_tab <- full_join(global_est, country_est, by=c("K_locus")) %>%
  full_join(country_est_lower, by=c("K_locus")) %>%
  full_join(country_est_upper, by=c("K_locus"))

# print output table
#write.csv(results_tab, file="Kp_NNS_raw_sitePooled_regionSubgroup_GLMMorInverse.csv", row.names=F)

```

# pooled estimates (region as subgroup) for cluster-adjusted counts
``` {r}

  # setup variables to store results
  global_est <- read_csv("\n", col_names = c("K_locus", "est", "lower", "upper"))
  country_est <- read_csv("\n", col_names = c("K_locus", unique(site_prevalence$Subregion)))
  country_est_lower <- read_csv("\n", col_names = c("K_locus", unique(site_prevalence$Subregion)))
  country_est_upper <- read_csv("\n", col_names = c("K_locus", unique(site_prevalence$Subregion)))
    
  # fit metaprop model for each K and store results
  for (kl in unique(site_prevalence$K_locus)) {
    
    # model output
    site_est <- NULL
    
    suppressWarnings({
      
    # try to fit with GLMM
    u <- try(
      site_est <- site_prevalence %>%
      filter(K_locus==kl) %>% 
      metaprop(event=adj_count, n=adj_sum, studlab=Site, subgroup=Subregion,  
        method = "GLMM", sm = "PLOGIT", fixed = FALSE, random = TRUE, method.random.ci = TRUE, method.incr = "if0all", control=list(maxiter=1000,stepadj=0.5), warn=F),
    silent=T)
    
    # if didnt' work, try to fit with Inverse
    if (is.null(site_est)) {
      u <- try(
        site_est <- site_prevalence %>%
        filter(K_locus==kl) %>% 
        metaprop(event=adj_count, n=adj_sum, studlab=Site, subgroup=Subregion,  
          method = "Inverse", sm = "PLOGIT", fixed = FALSE, random = TRUE, method.random.ci = TRUE, method.incr = "if0all", control=list(maxiter=1000,stepadj=0.5), warn=F),
      silent=T)
    }
    
    })
    
    # if we have a model result, store the output
    if(!is.null(site_est)) {
       global_est <- bind_rows(global_est, 
                               c(K_locus=kl,
                                      est=1/(1+exp(-1*site_est$TE.random)),
                                      lower=1/(1+exp(-1*site_est$lower.random)),
                                      upper=1/(1+exp(-1*site_est$upper.random)) 
                               )
                        )
       country_est <- bind_rows(country_est, 
                                c(K_locus=kl, 1/(1+exp(-1*site_est$TE.random.w))))
       country_est_lower <- bind_rows(country_est_lower, 
                                      c(K_locus=kl, 1/(1+exp(-1*site_est$lower.random.w))))
       country_est_upper <- bind_rows(country_est_upper, 
                                      c(K_locus=kl, 1/(1+exp(-1*site_est$upper.random.w))))
    }
    
  }
  
# combine the outputs into a single table
country_est_lower <- country_est_lower %>% 
  rename_all(~str_replace_all(., "\\s+", "")) %>%
  rename_with(~paste0(., "_lower"), names(.)) %>% 
  rename(K_locus=K_locus_lower)

country_est_upper <- country_est_upper %>% 
  rename_all(~str_replace_all(., "\\s+", "")) %>%
  rename_with(~paste0(., "_upper"), names(.)) %>% 
  rename(K_locus=K_locus_upper)

results_tab_adj <- full_join(global_est, country_est, by=c("K_locus")) %>%
  full_join(country_est_lower, by=c("K_locus")) %>%
  full_join(country_est_upper, by=c("K_locus"))

# print output table
#write.csv(results_tab_adj, file="Kp_NNS_adj_sitePooled_regionSubgroup_GLMMorInverse.csv", row.names=F)

```

``` {r }
# raw & adjusted prevalence, not pooled
adj_prevalence <- data_NNS %>% 
  raw_adj_prop(grouping_vars = c("K_locus"), summarise_by = "K_locus", adj_vars = c("Cluster", "Site")) %>%
  select(K_locus, raw_count, adj_count) %>%
  mutate(p_raw=raw_count/sum(raw_count), p_adj=adj_count/sum(adj_count))
```

``` {r }
combined <- results_tab %>% 
  select(K_locus, est, lower, upper) %>% 
  rename(est_unadj_pooled=est, lower_unadj_pooled=lower, upper_unadj_pooled=upper) %>%
  full_join(results_tab_adj, by=c("K_locus")) %>%
  rename(est_adj_pooled=est, lower_adj_pooled=lower, upper_adj_pooled=upper)
  
combined <- adj_prevalence %>% full_join(combined, by=c("K_locus"))

# write.csv(combined, file="Kp_NNS_raw_adj_poolRegionGLMMinverse.csv", row.names=F)

```

# plots
``` {r}
combined %>% ggplot(aes(x=as.numeric(est_adj_pooled), y=as.numeric(p_adj))) + 
    geom_text(aes(label=K_locus)) + 
    labs(x="K. pneumo prevalence (cluster-adjusted, global pooled estimate)", 
         y="K. pneumo prevalence (cluster-adjusted crude estimate)") +
    theme_bw()

combined %>% ggplot(aes(x=as.numeric(est_adj_pooled), y=as.numeric(p_raw))) + 
    geom_text(aes(label=K_locus)) + 
    labs(x="K. pneumo prevalence (cluster-adjusted, global pooled estimate)", 
         y="K. pneumo prevalence (crude estimate)") +
    theme_bw()

top20K_adj_or_pooled <- c("KL2", "KL15", "KL62", "KL25", "KL102", "KL23", "KL17", "KL64", "KL30", "KL122", "KL3", "KL14", "KL10", "KL19", "KL112", "KL106", "KL48", "KL52", "KL28", "KL54", "KL51", "KL116")

pooled_vs_crudeAdj <- combined %>% filter(K_locus %in% top20K_adj_or_pooled) %>%
  ggplot(aes(x=as.numeric(p_adj), y=as.numeric(est_adj_pooled))) + 
  geom_text(aes(label=K_locus)) + 
  labs(x="Cluster-adjusted crude estimate", y="Cluster-adjusted, global pooled estimate") +
  theme_bw() + geom_abline(slope=1, intercept = 0) + xlim(0,0.1) + ylim(0,0.1)

pooled_vs_crudeAdj

# ggsave(file="pooled_vs_crudeAdj.pdf", plot=pooled_vs_crudeAdj, width=8, height=8)

```

# top 20 global K, by crude and pooled estimates (both cluster-adjusted)
## pooled global & regional estimates
``` {r}
region_freq <- combined %>% 
  filter(K_locus %in% top20K_adj_or_pooled) %>% 
  select(K_locus, `Southern Asia`,`Eastern Africa`,`Western Africa`,`Southern Africa`, est_adj_pooled) %>% 
  #rename(Global=est_adj_pooled) %>%
  pivot_longer(cols=c(`Southern Asia`,`Eastern Africa`,`Western Africa`,`Southern Africa`), names_to="Region", values_to="pooled_adj_region") %>%
 # pivot_longer(cols=c(Global, `Southern Asia`,`Eastern Africa`,`Western Africa`,`Southern Africa`), names_to="Region", values_to="pooled_adj_region") %>%
  #mutate(Region=fct_relevel(Region,c("Global", "Southern Asia", "Eastern Africa", "Western Africa", "Southern Africa"))) %>%
  mutate(Region=fct_relevel(Region,c("Southern Asia", "Eastern Africa", "Western Africa", "Southern Africa"))) %>%
  mutate(K_locus=fct_relevel(K_locus, rev(top20K_adj_or_pooled))) %>%
  ggplot(aes(x=Region, y=K_locus, fill=as.numeric(pooled_adj_region))) + 
  geom_tile() +
  scale_fill_gradient(low="white", high="red") + 
  geom_text(aes(label = round(as.numeric(pooled_adj_region)*100,2)), color = "black", size = 4) + 
  labs(fill="Pooled estimate", y=NULL)

barplot <- combined %>% 
  filter(K_locus %in% top20K_adj_or_pooled) %>% 
  mutate(K_locus=fct_relevel(K_locus, rev(top20K_adj_or_pooled))) %>%
  ggplot(aes(x=K_locus, y=as.numeric(est_adj_pooled))) + geom_bar(stat="identity") + coord_flip()+ 
  labs(y="Pooled estimate", y=NULL) + theme_bw()

bar_and_heat <- barplot + region_freq + plot_layout(widths = c(1, 4))

bar_and_heat

#ggsave(file="region_freq.pdf", width=8, height=8, plot=bar_and_heat)

```

# examples of modelling
``` {r}

# KL102
site_prevalence %>%
    filter(K_locus=="KL102") %>% 
    metaprop(event=adj_count, n=adj_sum, studlab=Site, subgroup=Subregion,  
             method = "GLMM", sm = "PLOGIT", fixed = FALSE, random = TRUE, method.random.ci = TRUE, method.incr = "if0all", control=list(maxiter=1000,stepadj=0.5)) %>%
    forest.meta(layout="RevMan5", study.results=T)

# KL2
site_prevalence %>%
    filter(K_locus=="KL2") %>% 
    metaprop(event=adj_count, n=adj_sum, studlab=Site, subgroup=Subregion,  
             method = "GLMM", sm = "PLOGIT", fixed = FALSE, random = TRUE, method.random.ci = TRUE, method.incr = "if0all", control=list(maxiter=1000,stepadj=0.5)) %>%
    forest.meta(layout="RevMan5", study.results=T)
```

# Compare E. coli KL data
``` {r}
ec <- read_csv("testdata/Ec_blood_KpKL_cov70_id70.csv")
```

``` {r}
kp_ec <- ec %>% rename(K_locus=`capsule type`, ec_raw_count=count, ec_raw_p = percentage) %>%
  full_join(combined, by=c("K_locus"))

# write.csv(kp_ec,file="kp_ec.csv")

kp_est_adj_pooled_vs_Ec <- kp_ec %>% ggplot(aes(x=ec_raw_p/100, y=as.numeric(est_adj_pooled))) + 
  geom_text(aes(label=K_locus)) + 
  labs(x="E. coli prevalence", y="K. pneumo prevalence (cluster-adjusted, global pooled estimate)") +
  theme_bw()

kp_est_adj_pooled_vs_Ec

#ggsave(file="kp_est_adj_pooled_vs_Ec.pdf", plot=kp_est_adj_pooled_vs_Ec, width=8, height=8)

kp_ec %>% ggplot(aes(x=ec_raw_p/100, y=as.numeric(p_adj))) + 
  geom_text(aes(label=K_locus)) + 
  labs(x="E. coli prevalence", y="K. pneumo prevalence (cluster-adjusted crude estimate)") +
  theme_bw()
```

# proportion of cases in clusters, per site
``` {r }
cluster_size <- data_NNS %>% group_by(Cluster, Site) %>% summarise(Cluster_Size=n())

cluster_list <- data_NNS %>% left_join(cluster_size, by=c("Cluster", "Site")) %>%
  filter(Site %in% sites_n10$Site) %>% 
    group_by(Site, Cluster) %>%
    summarise(n=n()) 

cluster_stats <- cluster_list %>%
  group_by(Site) %>%
  summarise(num_iso=sum(n),
            num_clusters=n(),
            num_in_clusters_min=sum(n)-num_clusters, # excluding first per cluster
            num_in_clusters_max=sum(n)-sum(n==1), # total in clusters
            p_min=num_in_clusters_min/num_iso,
            p_max=num_in_clusters_max/num_iso)

plot(sort(num_clusters$p_max))
```